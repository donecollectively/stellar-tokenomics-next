# Post-Work Audit: Non-ADA Pricing CostToken

**Work Unit**: `20260224.non-ada-pricing-cost-token.workUnit.md` (p7k2m9x4q6)
**Date**: 2026-02-25
**Reviewers**: Architect, Code Whisperer, Domain-Fit Tester (Stellar Testing)

## Audit Scope

**Files examined**:
- `src/MarketSale/DynamicSaleV1Settings.hl` — CostToken enum + helpers + settings field
- `src/MarketSale/DynamicSaleV1.hl` — isRightPayment refactor to micro-token Int arithmetic
- `src/MarketSale/MarketSalePolicy.hl` — Check A (SellingTokens) + WithdrawingProceeds update
- `src/MarketSale/MarketSaleController.ts` — offchain cost-token helpers + pricing refactor
- `src/MarketSale/MarketSaleDataWrapper.ts` — type fix + priceExpansion bug fix
- `src/MarketSale/tests/MarketSale.costToken.test.ts` — 10 new cost-token tests
- `src/MarketSale/tests/MarketSaleTestHelper.ts` — TUNA helpers + snapshot chain
- `src/MarketSale/tests/MarketSale.test.ts` — ADA regression fixes
- `src/MarketSale/MarketSale.onchain.reqts.md` — requirements doc
- `src/MarketSale/MarketSale.onchain.reqts.jsonl` — requirements JSONL source of truth

**Implementation evolution assessed**: D1 (scale as multiplier), micro-token Int arithmetic, priceExpansion bug fix discovery.

## Findings

#### Finding: pw-f1 — Uncommitted test/helper changes — checkpoint incomplete
**Status**: resolved
**Severity**: Concern
**Reviewer**: Code Whisperer
**Location**: In `MarketSaleTestHelper.ts` (withdrawProceeds helper), `MarketSale.test.ts` (ADA withdrawal tests), and `MarketSale.costToken.test.ts` (TUNA withdrawal test)

**Observation**: The working tree has uncommitted changes to three test files beyond the latest commit (`0b549ce`). These include: the `withdrawProceeds` interface change from `bigint` to `number`, `builderVersion` bump (2→3), `travelToFuture` addition to `firstMarketSalePaused`, error regex update for Check A, and all call-site updates (`2_000_000n` → `2.0`, `1n` → `1.0`). The committed test code likely doesn't pass because: (a) the Check A error regex was changed on-chain but the committed test still matches the old regex, and (b) the `firstMarketSalePaused` builder lacks the `travelToFuture` needed after the upstream `tcx.txnTime` fix.

**Resolution**: Stakeholder committed the outstanding changes in 3 commits (7af7e1f, 3ee03c8, c4ef7e1). Checkpoint now complete — working tree clean.

#### Finding: pw-f2 — reqts.md not regenerated from JSONL after status updates
**Status**: resolved
**Severity**: Concern
**Reviewer**: Code Whisperer (traceability)
**Location**: In Area 14 section of `src/MarketSale/MarketSale.onchain.reqts.md`

**Observation**: Area 14 requirements (REQT-90fsr7px0z, nb3v1zg4fv, j7cf4ew85g, y5gge63n84, 4zkj5q4n38) show `**NEXT**/draft` in the reqts.md but `IMPLEMENTED/NEEDS VERIFICATION` in the JSONL source of truth. Additionally, REQT-4zkj5q4n38's statement in reqts.md still says "scale outside the range 1–19" instead of the updated "scale multiplier outside the range 1–10^19" (reflecting Implementation Decision D1). The reqts.md was not regenerated after the JSONL was updated.

**Resolution**: Regenerated reqts.md from JSONL using `generate-reqts.mjs`. All Area 14 statuses and statements now match the JSONL source of truth. Commit aecb95d.

#### Finding: pw-f3 — REQT-jxdnb3dxmx spam rejection code path not exercised by its attributed test
**Status**: open
**Severity**: Concern
**Reviewer**: Domain-Fit Tester (Stellar Testing)
**Location**: In `non-ada-wrong-token` test at `src/MarketSale/tests/MarketSale.costToken.test.ts:173`

**Observation**: The `non-ada-wrong-token` test carries `REQT/jxdnb3dxmx` (Payment Denomination Enforcement) attribution but fails at Check A in `MarketSalePolicy.hl` — `costToken.microTokensFromValue(lotSellPrice)` throws "key not found" when the redeemer contains a FISH-denominated value instead of TUNA. It never reaches the spam rejection logic in `DynamicSaleV1.hl` `isRightPayment()` (the `bREQTgroup` that asserts `payment.get_assets() == expectedAssets`). No test exercises the actual REQT-jxdnb3dxmx code path: a payment containing the correct cost token PLUS unexpected additional tokens injected alongside it.

**Resolution**: —

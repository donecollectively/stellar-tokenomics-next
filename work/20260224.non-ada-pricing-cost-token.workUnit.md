# Work Unit: p7k2m9x4q6

**Title**: Non-ADA Pricing: CostToken Enum & Pricing Abstraction
**Created**: 2026-02-24
**Source**: ad-hoc
**Status**: Created

> **Required context**: Load [work-planner.SKILL.md](../../skillz/work-planner/work-planner.SKILL.md) for lifecycle protocol, team composition, and sign-off procedures before operating on this work unit.

## Scope

**Required Skills**: Onchain Coder, Offchain Coder, Stellar Testing
**ARCH Items**: MarketSale delegate policy, DynamicSaleV1 pricing model, DynamicSaleV1Settings data model
**REQT Items**:

New requirements (Area 14: Cost Token Denomination):
 - REQT/90fsr7px0z (Cost Token Denomination) — top-level
 - REQT/nb3v1zg4fv (CostToken Enum Definition) — enum with ADA and Other variants
 - REQT/j7cf4ew85g (ADA Variant) — implicit scale=6, no fields
 - REQT/y5gge63n84 (Other Variant) — mph, tokenName, scale fields
 - REQT/4zkj5q4n38 (CostToken in Settings) — costToken field in DynamicSaleV1Settings

Evolved requirements:
 - REQT/gy6jd9cjkg (Tokens Must Remain) — evolved: only cost token may be withdrawn; sale tokens + UUT must remain
 - REQT/5r79v9b4ht (No Constraint on Withdrawal Amount) — evolved: "ADA" → "cost token"

Implementation-only changes (requirements already token-agnostic):
 - REQT/jdkhmeg463 (Payment Matches Pricing Strategy) — `isRightPayment()` must use costToken helpers
 - REQT/hk93w5zb16 (UTxO Token Assets Unchanged) — sufficient as-is; state-only transitions don't move proceeds
 - REQT/03ff0mfddc, 998waf4mz3, dtpwzjqn9p (Stopping/Resuming/Retiring UTxO checks) — reference hk93w5zb16, no change needed

## Problem / Context

The MarketSale pricing system is currently hardcoded to ADA throughout. On-chain, `DynamicSaleV1.isRightPayment()` uses `get_lovelace()` and divides by `1_000_000.0` to convert between Value and Real. Off-chain, the controller has already been refactored (commits since a101b) to use `costTokenScale()`, `mkCostTokenValue()`, `costTokenAmount()`, and `costTokenIsADA()` — abstracting the cost token denomination. The on-chain code must now follow suit.

### What needs to change

**1. Data model — CostToken enum:**

Add a `CostToken` enum to the on-chain data model:
```
enum CostToken {
    ADA                                    // implicit scale=6
    Other { mph, tokenName, scale: Int }   // e.g. scale=6 for USDC
}
```
With helper methods: `costTokenScale()`, `toCostValue(amount)`, `costAmountFromValue(v)`.

This enum is added to `DynamicSaleV1Settings` as a new field `costToken: CostToken`, defaulting to `ADA`.

**2. Pricing validation — `isRightPayment()`:**

`DynamicSaleV1.isRightPayment()` currently:
- Extracts price via `lotPrice.get_lovelace() / 1_000_000.0` — hardcoded ADA
- Extracts payment via `payment.get_lovelace() / 1_000_000.0` — hardcoded ADA
- Asserts `payment.get_assets().is_zero()` — rejects any non-ADA assets

Must change to use `costToken` helpers for extraction and scale, and adjust the asset check to be cost-token-aware.

**3. Lifecycle transition checks — ADA tolerance vs. cost-token proceeds:**

Stopping, Resuming, and Retiring currently check:
```
UTxO token assets (non-ADA) unchanged
ADA within 1 ADA tolerance (for minUtxo shifts)
```

When the cost token is non-ADA, accumulated sale proceeds ARE non-ADA tokens. The current "non-ADA tokens unchanged" check would block legitimate proceeds accumulation or prevent withdrawal. These checks must distinguish between:
- **Sale tokens** (the tokens being sold — always stay locked)
- **Cost tokens** (the payment token — proceeds accumulate, can be withdrawn)
- **ADA** (always present for minUtxo — may shift within tolerance)

**4. WithdrawingProceeds — cost-token awareness:**

Currently checks "non-ADA tokens must remain in UTxO." When cost token is non-ADA, the proceeds to withdraw ARE non-ADA tokens. Must distinguish between sale tokens (must remain) and cost tokens (may be withdrawn).

### What does NOT change

- The pricing algorithm itself (`lotPriceForSale`, `pricingFactorOverallProgress`, `pricingFactorDynamicPace`, `nextSalePace`) — these operate on `Real` values in abstract units and are already token-agnostic
- Time calculations (`elapsedSaleHours`, `DTS_PurchaseInfo::create` hour math) — `1_000_000` there is Duration arithmetic, not pricing
- Sale creation, activation, token management flows — structurally unchanged
- VXF None-mode enforcement — unaffected

### Off-chain status

The offchain controller (`MarketSaleController.ts`) has already been refactored with:
- `costTokenScale(mktSale)` — returns 6 (ADA), future: reads from sale data
- `costTokenIsADA(mktSale)` — returns true, future: checks costToken enum
- `mkCostTokenValue(mktSale, amount)` — `makeValue(amount)` for ADA, future: token Value
- `costTokenAmount(mktSale, v)` — `v.lovelace` for ADA, future: token quantity
- `salePricePerLot()` and `computeLotsForPurchase()` — use above helpers
- `mkTxnBuyFromMarketSale()` — uses `costTokenAmount` for payment predicate

These offchain stubs are ready to read the `costToken` field from on-chain data once the enum lands.

## Focus Files

- `src/MarketSale/DynamicSaleV1Settings.hl` — add CostToken enum, add costToken field to settings struct
- `src/MarketSale/DynamicSaleV1.hl` — refactor `isRightPayment()` to use costToken helpers
- `src/MarketSale/MarketSalePolicy.hl` — update lifecycle transition checks (Stopping, Resuming, Retiring, WithdrawingProceeds) for cost-token awareness
- `src/MarketSale/MarketSaleData.hl` — may need `costToken` accessor from settings for use in validation helpers
- `src/MarketSale/MarketSaleController.ts` — offchain stubs already done; will need to read costToken from data once enum lands
- `src/MarketSale/MarketSale.onchain.reqts.jsonl` — requirements source of truth
- `src/MarketSale/MarketSale.onchain.reqts.md` — generated requirements doc

## Plan / Guidance

### Phase 1: CostToken Enum & Data Model

**Onchain** (osiris):
- Define `CostToken` enum in `DynamicSaleV1Settings.hl` with `ADA` and `Other{mph, tokenName, scale}` variants
- Add helper methods: `costTokenScale()`, `toCostValue(amount)`, `costAmountFromValue(v)`, `isCostToken(ac)` (checks whether an AssetClass is the cost token)
- Add `costToken: CostToken` field to `DynamicSaleV1Settings`
- Update `validateUpdatedDetails()` to validate costToken bounds (e.g., scale > 0, scale <= 19)

### Phase 2: Pricing Validation Refactor

**Onchain** (osiris):
- Refactor `DynamicSaleV1.isRightPayment()` to use `self.settings.costToken` helpers
- Replace `lotPrice.get_lovelace() / 1_000_000.0` with cost-token-aware extraction
- Replace `payment.get_lovelace() / 1_000_000.0` with cost-token-aware extraction
- Replace `payment.get_assets().is_zero()` with cost-token-aware check

### Phase 3: Lifecycle Transition Checks — No Change Needed

Stopping, Resuming, and Retiring UTxO checks (REQT-03ff0mfddc, 998waf4mz3, dtpwzjqn9p) are sufficient as-is. State-only transitions don't move proceeds, so "non-ADA tokens unchanged" is correct regardless of cost token denomination.

### Phase 4: WithdrawingProceeds Update

**Onchain** (osiris):
- Refactor WithdrawingProceeds "non-ADA tokens must remain" to "sale tokens must remain"
- Allow cost-token withdrawal when costToken is non-ADA
- Datum unchanged check is already cost-token-agnostic (Data equality)

### Phase 5: Offchain Integration

**Offchain** (freya):
- Update `costTokenScale()` to read from sale data's `costToken` field
- Update `costTokenIsADA()` to check `costToken` enum variant
- Update `mkCostTokenValue()` and `costTokenAmount()` for Other variant
- Ensure type bridge regeneration picks up new enum

### Phase 6: Testing

**Tests** (tessa):
- Existing ADA-denominated tests should pass unchanged (CostToken::ADA is default)
- New tests for Other cost token pricing
- Lifecycle transition tests with non-ADA cost token
- WithdrawingProceeds with non-ADA cost token

## Acceptance Criteria

- [ ] `CostToken` enum defined on-chain with `ADA` and `Other` variants (REQT-j7cf4ew85g, y5gge63n84)
- [ ] `costToken` field added to `DynamicSaleV1Settings` with scale validation (REQT-4zkj5q4n38)
- [ ] `isRightPayment()` uses cost-token-aware extraction (no hardcoded `get_lovelace()`)
- [ ] WithdrawingProceeds allows cost-token withdrawal; sale tokens + UUT must remain (REQT-gy6jd9cjkg)
- [ ] Existing ADA-denominated tests pass without modification
- [ ] New requirements traced with REQT* / REQT/ annotations
- [ ] Offchain stubs updated to read costToken from on-chain data

## Sign-Offs

### Pre-Work
| Reviewer | Status | Date | Notes / References |
|----------|--------|------|--------------------|
| Architect | Pending | — | — |
| Code Whisperer | Pending | — | — |
| Domain-Fit Tester (Stellar Testing) | Pending | — | — |

### Post-Work
| Reviewer | Status | Date | Notes / References |
|----------|--------|------|--------------------|
| Architect | Pending | — | — |
| Code Whisperer | Pending | — | — |
| Domain-Fit Tester (Stellar Testing) | Pending | — | — |

## Advisory Notes

_Pending pre-work collaborative review._

## Worker Report

_Not yet started._

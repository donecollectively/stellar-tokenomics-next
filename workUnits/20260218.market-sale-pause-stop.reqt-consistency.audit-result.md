# Audit Result: MarketSale Reqts ↔ Work Unit Consistency

**Date**: 2026-02-18
**Subject**: `src/MarketSale/MarketSale.onchain.reqts.jsonl` ↔ `workUnits/20260218.market-sale-pause-stop.workUnit.md`
**Auditor expertise**: REQM + Work Planner (consistency lens)
**Theme**: Prevent divergence between separately-developed requirements and work unit

## Purpose

The requirements (JSONL) and the work unit were developed in separate sessions. This audit verifies they describe the same behavior, have consistent statuses, and won't mislead implementers or downstream consumers about what's implemented vs. planned.

## Files in Scope

- `src/MarketSale/MarketSale.onchain.reqts.jsonl` — 188-line JSONL requirements
- `workUnits/20260218.market-sale-pause-stop.workUnit.md` — draft work unit
- `src/MarketSale/MarketSaleData.hl` — on-chain data types (ground truth)
- `src/MarketSale/MarketSalePolicy.hl` — on-chain policy (ground truth)

## Findings

#### Finding: kx7m2nfq3w — COMPLETED reqts describe unimplemented 2.0 behavior
**Status**: resolved
**Location**: REQT-46gmm6198w (3.0 Sale Lifecycle), REQT-1whgp2m8jq (3.1.2 Active State), REQT-w6e5qsfxq1 (6.2.0 VXF Destination Validation on State Transitions)

**Observation**: Three COMPLETED requirements had their statements/functionals updated to describe the full 2.0 target state machine (Active ⇄ Paused, Resuming, paused updates), but their impl_status was left at COMPLETED. The on-chain code has no Paused state, no mustBePaused, no Stopping/Resuming activities. Someone reading these COMPLETED reqts would believe the lifecycle is fully implemented.

- REQT-46gmm6198w functional: "Active ⇄ Paused, and Paused → Retired" — not implemented
- REQT-1whgp2m8jq statement: "Entered via Activating (from Pending) or Resuming (from Paused)" — Resuming doesn't exist
- REQT-w6e5qsfxq1 functional: "paused updates validate if present, and Resuming re-validates" — not implemented

**Resolution**: Changed impl_status to NEXT and maturity to draft for all three reqts.

#### Finding: r3qm7vf2wd — Resuming activity missing validate() requirement
**Status**: resolved
**Location**: REQT-qh3qkk8f92 (10.2.0 Resuming Activity) — missing child requirement

**Observation**: Activating (REQT-wt32kvjm9f, outline 7.1.7) requires the activated record to pass `validate()`. Resuming has no equivalent requirement. Between Stop and Resume, UpdatingPausedSale may have changed name, settings, and VXF destinations. While UpdatingPausedSale validates individually, Resuming re-entering Active state should also call validate() for defense-in-depth — this is financial code affecting real revenue.

**Resolution**: Added REQT-fkww59zyt3 (10.2.5 General Validation Passes on Resume) requiring validate() on Resume, mirroring Activating. Updated work unit plan and acceptance criteria.

#### Finding: w8n4jp6k2c — Module description has linear state machine
**Status**: resolved
**Location**: MOD-0rndkpc314 description field

**Observation**: Module description says "Sales transition through Pending → Active → Paused → Retired/SoldOut" — a linear progression. The actual design is bidirectional: Active ⇄ Paused. This is the first thing someone reads when loading these requirements.

**Resolution**: Fixed MOD-0rndkpc314 background to "Pending → Active ⇄ Paused, with Paused → Retired/SoldOut".

#### Finding: t5gq8mx3rh — Work unit state diagram contradicts advisory notes
**Status**: resolved
**Location**: Work unit Problem/Context section, "State Machine Change" diagram

**Observation**: The diagram shows "(both can → Retired)" with arrows suggesting Active → Retired is valid. But the advisory notes explicitly state "Retiring transitions from Paused only" and "Direct Active → Retired is not supported — you must Stop first." REQT-7j07yjvpbh (3.3.1) also rejects Active → Retired. If someone reads only the diagram, they'll implement wrong transitions.

**Resolution**: Fixed diagram to "Pending → Active ⇄ Paused → Retired" with note "(must Stop before Retiring — Paused is the deliberation state)".

#### Finding: h9vy2pk4nw — Work unit REQT Items stale
**Status**: resolved
**Location**: Work unit Scope section, REQT Items field

**Observation**: Says "*(none formalized yet — gap)*" but requirements now exist in `MarketSale.onchain.reqts.jsonl`. The work unit should reference the formal REQTs to establish traceability. This was accurate when the draft was created but is now stale.

**Resolution**: Populated REQT Items with 26 formal REQT references covering all in-scope requirements. Removed REQT gap from Gaps field.

#### Finding: p3km8wr6tx — Work unit acceptance criteria missing "No State Regression from Retired"
**Status**: resolved
**Location**: Work unit Acceptance Criteria section

**Observation**: REQT-w0hvrt4xx8 (3.3.3 No State Regression from Retired) is NEXT and in scope for this work unit. The acceptance criteria don't mention it. While it may be "implied" by Retiring being Paused-only, explicit is better than implicit for financial code — an implementer should verify this negative case.

**Resolution**: Added explicit acceptance criterion: "Once Retired, no transition back to any other state is permitted (REQT/w0hvrt4xx8)".

#### Finding: q2fx5nh7vd — Resuming missing datum-unchanged checks for non-editable fields
**Status**: resolved
**Location**: REQT-qh3qkk8f92 (10.2.0 Resuming Activity) — missing validation

**Observation**: Stopping (REQT-nxqq219k4r, 10.1.3) explicitly checks "all datum fields unchanged." Resuming doesn't check that frozen fields (saleAssets, startAt, progressDetails, threadInfo) are unchanged from input to output. While the only mutation path during Paused state is UpdatingPausedSale (which enforces frozen fields), explicit verification on Resume is defense-in-depth. The Resuming activity changes state from Paused → Active but should verify no other fields changed in the same transaction.

**Resolution**: Added REQT-60azhtn9dy (10.2.6 Non-Editable Fields Unchanged on Resume) enumerating all fields that must be unchanged. Updated work unit plan and acceptance criteria.

## Coverage

- [x] Status alignment (COMPLETED vs actual implementation)
- [x] Statement/functional accuracy vs code
- [x] Activity-by-activity mapping (work unit ↔ reqts)
- [x] Frozen/editable field inventory consistency
- [x] State machine diagram consistency
- [x] Acceptance criteria coverage
- [x] VXF integration consistency
- [x] Area assignment correctness
- [x] Parent-child status relationships
- [x] Defense-in-depth validation gaps

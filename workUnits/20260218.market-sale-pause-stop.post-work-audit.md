# Post-Work Audit: market-sale-pause-stop

**Date**: 2026-02-19
**Work Unit**: [20260218.market-sale-pause-stop.workUnit.md](./20260218.market-sale-pause-stop.workUnit.md)
**Audit types**: Architect post-work sign-off, Code Whisperer post-work, Stellar Testing post-work

## Scope

Files reviewed:
- `src/MarketSale/MarketSaleData.hl` — state enum, validation helpers, shared/Paused-specific validators
- `src/MarketSale/MarketSalePolicy.hl` — SpendingActivity enum, Stopping/Resuming/UpdatingPausedSale/Retiring handlers
- `src/MarketSale/SaleProgressDetails.hl` — `validateDetailsWhenPaused`
- `src/MarketSale/MarketSaleController.ts` — off-chain builders, `beforeUpdate()`, `requirements()`
- `src/MarketSale/tests/MarketSale.test.ts` — 30 new tests across 4 activities
- `src/MarketSale/tests/MarketSaleTestHelper.ts` — 4 helpers, 3 snapshots, `assertEnforcedReqts`

## Architect — 1 finding

### Verified (clean pass on initial analysis):


- **State machine matches plan**: Active ⇄ Paused → Retired. No direct Active → Retired path — Retiring requires `mustBePaused`.
- **SellingTokens rejects Paused automatically** via existing `mustBeActive` on both prev/next state — no redundant Paused-specific guard added (per plan item 3).
- **Child chunk policy comment present** in `MarketSalePolicy.hl` at SellingTokens handler.
- **Frozen/editable field boundaries match plan exactly** — `validateUpdatePausedSale` enforces the documented inventory, `validateCommonUpdateChecks` extracted as mandated.
- **No unvetted architectural decisions introduced** during implementation.
- **Retiring is state-transition-only** — tokens stay locked for future CleanupRetired, matching the F1 resolution.
- **Requirements entries in `requirements()`** cover all four new activities with correct mech labels matching test slugs.

#### Finding: pw-arch-f1 — UTxO value check relaxed from exact equality to asset equality + ADA tolerance
**Status**: open
**Location**: In Stopping/Resuming/Retiring handlers at `src/MarketSale/MarketSalePolicy.hl` (commit `0306f26`)

**Observation**: Commit `0306f26` changed all three state-transition UTxO value checks from exact `input().value == output().value` to `get_assets() == get_assets()` + `adaDiff <= 1000000` (1 ADA tolerance). The commit message explains: "adjusted to allow for small ada changes due to minUtxo shifts when changing status."

This is a legitimate practical fix — changing the datum's state field alters CBOR encoding size, which can shift the minUtxo requirement. But it's an implementation evolution that changes enforcement semantics:
- Pre-work plan: "UTxO token value must not change"
- Acceptance criteria: "UTxO value unchanged (tokens stay locked)"
- REQTs (03ff0mfddc, dtpwzjqn9p, 998waf4mz3): describe "UTxO value unchanged"
- On-chain reqt text now says: "UTxO token assets unchanged, ADA within 1 ADA tolerance"

The requirements and acceptance criteria need updating to reflect the actual enforcement policy.

**Resolution**: Updated 4 REQTs in JSONL (REQT-hk93w5zb16 parent + REQT-tx3fyv3eb2/998waf4mz3/dtpwzjqn9p per-activity) — title changed from "UTxO Value Unchanged" to "UTxO Token Assets Unchanged", statements now specify: token assets (non-ADA) must not change, ADA may shift within 1 ADA tolerance for minUtxo. Regenerated reqts.md. Updated work unit acceptance criteria and frozen field inventory table. Rationale: changing the state enum field (e.g., Active → Paused) alters the datum's CBOR encoding size, which can shift the Cardano minUtxo requirement by a small amount of ADA. The 1 ADA tolerance accommodates this without allowing token movement.

## Code Whisperer — 2 findings

#### Finding: pw-cw-f1 — Incorrect comment claims REQT/fkww59zyt3 is unimplemented
**Status**: open
**Location**: In `describe("Resuming activity")` comment block (test removal justification) at `src/MarketSale/tests/MarketSale.test.ts:1960-1963`

**Observation**: The comment states: "REQT/fkww59zyt3 itself is false — Resuming doesn't call validate()." This is factually incorrect. The on-chain Resuming handler in `MarketSalePolicy.hl:690-691` explicitly calls `updated.validate()` with REQT-fkww59zyt3 tracing:

```helios
&& bREQT(
    reqt: "datum passes general validation on resume (REQT-fkww59zyt3)",
    assertion: updated.validate(),
    showSuccess: true
)
```

The test removal itself is reasonable — `validateStateOnlyChange` freezes all datum fields including name, making it impossible to construct a scenario where validate() catches something validateStateOnlyChange doesn't. But the comment's claim that the REQT is false contradicts the actual implementation and the acceptance criteria ("Resuming calls `validate()` for defense-in-depth datum integrity").

**Resolution**: Comment rewritten to accurately describe why the negative test is impractical while acknowledging the defense-in-depth exists on-chain. Coverage provided via `assertEnforcedReqts` wiring proof on the Resuming happy path (see pw-st-f1).

#### Finding: pw-cw-f2 — Implementation evolution in 0306f26 not captured in worker reports
**Status**: open
**Location**: `src/MarketSale/MarketSaleData.hl` and `src/MarketSale/MarketSalePolicy.hl` (commit `0306f26`)

**Observation**: Commit `0306f26` (authored by stakeholder, after worker reports) made two categories of changes not captured in any worker report:

1. **REQT traceability additions to `validate()`**: Name length check tagged REQT-y16j4t955c. SaleAssets validation grouped under REQT-egttdcamhg. These are the IDs referenced by `assertEnforcedReqts` in the UpdatingPausedSale and (now) Resuming happy path tests — without this commit, the wiring proofs would fail.

2. **REQT traceability additions to `validateCommonUpdateChecks()`**: UTxO check tagged REQT-ntdbhc1xss, threadInfo tagged REQT-rg5zyhd2gb, VxfDestination tagged REQT-6z88fg6j2s, settings tagged REQT-b731sye0fz.

3. **Test error regex corrections**: Four UpdatingPausedSale frozen-field tests had regex patterns updated to match actual on-chain error messages (e.g., `/salePace.*must equal previous|carry forward/` → `/salePace can't be modified while Paused/`).

These are positive improvements (traceability, test accuracy) but represent implementation evolution that should be documented so the post-work review is working against the actual final state.

**Resolution**: Noted as implementation evolution. No code changes needed — the traceability additions and regex corrections are correct. Documented here so the post-work review record acknowledges the full changeset including stakeholder-authored commit `0306f26`.

## Stellar Testing — 2 findings

#### Finding: pw-st-f1 — Missing wiring proof for validate() on Resuming
**Status**: open
**Location**: In `describe("Resuming activity")` at `src/MarketSale/tests/MarketSale.test.ts` — happy path test `resume-paused-sale/REQT/3h96mdmn5k`

**Observation**: The UpdatingPausedSale happy path test includes `assertEnforcedReqts(tcx, [...])` to prove the shared `validateCommonUpdateChecks` pipeline ran. The Resuming happy path has no equivalent wiring proof, yet Resuming has its own defense-in-depth checks (validate(), VxfDestination, token presence) that should be confirmed as running. Specifically, REQT-fkww59zyt3 (validate() on resume) is implemented on-chain but has zero test coverage — neither a direct negative test nor a wiring proof.

Additionally, the test count in Advisory Notes (31) is now 30 after the resume-invalid-name removal (Stopping:6 + Resuming:8 + UpdatingPausedSale:10 + Retiring:6 = 30).

**Resolution**: Added `assertEnforcedReqts` to Resuming happy path with 6 REQT traces covering: state transition (REQT-3h96mdmn5k), non-editable fields (REQT-60azhtn9dy), UTxO value (REQT-998waf4mz3), token presence (REQT-qh3qkk8f92), VxfDestination (REQT-jkbaba8n7n), and validate() defense-in-depth (REQT-fkww59zyt3). Test count remains 30 — no new `it()` block needed.

#### Finding: pw-st-f2 — Test count in Advisory Notes says 31, actual is 30
**Status**: open
**Location**: Multiple locations in Advisory Notes — "Stellar Testing Interview" section, test count summary table

**Observation**: After removal of `resume-invalid-name` test, actual count is Stopping:6 + Resuming:8 + UpdatingPausedSale:10 + Retiring:6 = 30. Advisory Notes still reference 31 in the test count summary table and several prose references.

**Resolution**: Test count summary table corrected to 30 (Resuming: 2 happy + 6 negative = 8). Historical references in interview logs and worker reports left as-is — they were accurate when written. The correction note in the table explains the discrepancy.
